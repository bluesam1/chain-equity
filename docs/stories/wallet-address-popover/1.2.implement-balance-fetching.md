# Story 1.2: Implement Balance Fetching for Wallet Address Popover

## Status
Ready for Review

## Story

**As a** user,
**I want** to see the token balance for any wallet address in the popover,
**so that** I can quickly check wallet balances without navigating to the balance page.

## Acceptance Criteria

1. Create `useWalletBalance` hook at `frontend/src/hooks/useWalletBalance.ts`
2. Hook accepts `address: string` parameter
3. Hook fetches token balance for any wallet address (not just connected wallet)
4. Hook uses `getBalance(address, provider)` from `lib/contract.ts`
5. Hook uses `getSymbol(provider)` and `getDecimals(provider)` for formatting
6. Hook uses `formatBalance(balance, decimals)` for display
7. Hook returns `balance: string | null` (formatted balance)
8. Hook returns `symbol: string | null` (token symbol)
9. Hook returns `isLoading: boolean` (loading state)
10. Hook returns `error: string | null` (error message if fetch fails)
11. Hook returns `refetch: () => void` (function to manually refetch balance)
12. Balance is only fetched when popover is shown (lazy loading)
13. Implement caching: cache balance results per address for 30 seconds
14. Invalidate cache after 30 seconds or on transaction events
15. Cancel in-flight requests when popover closes
16. Display loading state in popover while fetching balance
17. Display formatted balance (e.g., "1,234.56 TOK") when loaded
18. Display error message with retry option if fetch fails
19. Display "Balance: 0.00 TOK" if balance is zero (not an error)
20. Balance label uses `text-xs text-text-secondary` styling
21. Balance value uses `text-lg font-semibold text-text-primary` styling

## Tasks / Subtasks

- [x] Create useWalletBalance hook (AC: 1-11)
  - [x] Create `frontend/src/hooks/useWalletBalance.ts`
  - [x] Define hook interface with address parameter
  - [x] Implement balance fetching using `getBalance` from `lib/contract.ts`
  - [x] Implement symbol and decimals fetching
  - [x] Implement balance formatting using `formatBalance`
  - [x] Return balance, symbol, isLoading, error, and refetch
- [x] Implement lazy loading (AC: 12)
  - [x] Only fetch balance when popover is visible
  - [x] Pass visibility state to hook or trigger fetch on mount when visible
- [x] Implement caching strategy (AC: 13, 14)
  - [x] Create cache structure to store balance per address
  - [x] Store timestamp with cached balance
  - [x] Check cache before fetching
  - [x] Invalidate cache after 30 seconds
  - [x] Invalidate cache on Transfer events (listen to contract events)
- [x] Implement request cancellation (AC: 15)
  - [x] Use AbortController to cancel in-flight requests
  - [x] Cancel requests when popover closes or component unmounts
- [x] Integrate balance display in popover (AC: 16-21)
  - [x] Add balance section to WalletAddressPopover component
  - [x] Display loading spinner/skeleton while fetching
  - [x] Display formatted balance when loaded
  - [x] Display error message with retry button if fetch fails
  - [x] Display "0.00 TOK" for zero balance
  - [x] Apply proper typography styling

## Dev Notes

### Relevant Source Tree Info
- Balance hook: `frontend/src/hooks/useWalletBalance.ts`
- Contract utilities: `frontend/src/lib/contract.ts`
- Existing balance hook: `frontend/src/hooks/useBalance.ts` (for connected wallet only)
- Popover component: `frontend/src/components/WalletAddressPopover.tsx`

### Contract Integration
- Use `getBalance(address, provider)` from `lib/contract.ts`
- Use `getSymbol(provider)` and `getDecimals(provider)` for formatting
- Use `formatBalance(balance, decimals)` for display
- Provider: Use `new ethers.BrowserProvider(window.ethereum)` or `usePublicClient()` from wagmi

### Caching Implementation
```typescript
interface BalanceCache {
  [address: string]: {
    balance: string;
    symbol: string;
    timestamp: number;
  };
}

const CACHE_DURATION = 30000; // 30 seconds

// Check cache before fetching
const cached = cache[address];
if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
  return cached;
}
```

### Event Listening for Cache Invalidation
- Listen to Transfer events from contract
- Invalidate cache for addresses involved in transfers
- Use existing event listening pattern from `useBalance.ts`

### Error Handling
- Network errors: Show "Unable to load balance" with retry button
- Invalid address: Don't show popover (validate before showing)
- Timeout: Show error with retry option
- Provider errors: Show error message

### Integration Points
- Integrates with WalletAddressPopover component
- Uses existing contract utilities from `lib/contract.ts`
- Follows pattern from `useBalance.ts` but for any address
- Uses wagmi hooks for provider access

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | John (PM) |
| 2024-12-XX | 1.1 | Story implementation completed | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
1. Created useWalletBalance hook with address parameter
2. Implemented balance fetching using getBalance, getSymbol, getDecimals from lib/contract.ts
3. Implemented lazy loading - only fetches when popover is visible
4. Implemented caching strategy - 30 second cache per address with timestamp
5. Implemented cache invalidation on Transfer events
6. Implemented request cancellation using AbortController
7. Integrated balance display in WalletAddressPopover component
8. Added loading state with spinner
9. Added error state with retry button
10. Applied proper typography styling (text-xs for label, text-lg font-semibold for value)

### File List
- `frontend/src/hooks/useWalletBalance.ts` (created)
- `frontend/src/components/WalletAddressPopover.tsx` (modified - integrated balance display)

## QA Results

_To be populated by QA agent_

