# Story 2.2: Implement Allowlist Mechanism with Transfer Restrictions

## Status
Ready for Review

## Story

**As a** contract administrator,
**I want** an allowlist mechanism that restricts transfers to approved addresses,
**so that** only authorized wallets can send and receive tokens, ensuring compliance and security.

## Acceptance Criteria

1. Allowlist mapping implemented: `mapping(address => bool) public allowlist`
2. `approveWallet(address account)` function implemented (requires APPROVER_ROLE)
3. `revokeWallet(address account)` function implemented (requires APPROVER_ROLE)
4. `transfer()` function overridden to check BOTH sender AND recipient are on allowlist
5. `transferFrom()` function overridden to check BOTH sender AND recipient are on allowlist
6. Transfers revert with clear error message if sender not allowlisted
7. Transfers revert with clear error message if recipient not allowlisted
8. `AllowlistUpdated` event emitted when addresses are added/removed
9. View function `allowlist(address account)` returns allowlist status

## Tasks / Subtasks

- [x] Implement allowlist storage (AC: 1)
  - [x] Add `mapping(address => bool) public allowlist` state variable
- [x] Implement approveWallet function (AC: 2, 8)
  - [x] Add `onlyRole(APPROVER_ROLE)` modifier
  - [x] Set allowlist[account] = true
  - [x] Emit AllowlistUpdated event
- [x] Implement revokeWallet function (AC: 3, 8)
  - [x] Add `onlyRole(APPROVER_ROLE)` modifier
  - [x] Set allowlist[account] = false
  - [x] Emit AllowlistUpdated event
- [x] Override transfer function (AC: 4, 6, 7)
  - [x] Check sender is on allowlist (revert if not)
  - [x] Check recipient is on allowlist (revert if not)
  - [x] Call parent transfer function
- [x] Override transferFrom function (AC: 5, 6, 7)
  - [x] Check sender (from) is on allowlist (revert if not)
  - [x] Check recipient (to) is on allowlist (revert if not)
  - [x] Call parent transferFrom function
- [x] Define AllowlistUpdated event (AC: 8)
  - [x] Event signature: `event AllowlistUpdated(address indexed account, bool approved)`
- [x] Test allowlist functionality (AC: 9)
  - [x] Test approveWallet adds address to allowlist
  - [x] Test revokeWallet removes address from allowlist
  - [x] Test view function returns correct status

## Dev Notes

### Relevant Source Tree Info
- Contract location: `contracts/src/ChainEquityToken.sol`
- Test location: `contracts/test/ChainEquityToken.test.ts`
- Builds on Story 2.1 (contract structure must exist)

### Architecture Decisions
- Both sender AND recipient must be allowlisted (strict compliance)
- APPROVER_ROLE controls allowlist modifications
- Allowlist is public mapping for gas-efficient view access
- Clear revert messages for debugging: "Sender not allowlisted" and "Recipient not allowlisted"
- Event emitted for all allowlist changes for off-chain tracking

### Key Constraints
- Must override both transfer() and transferFrom() to prevent all transfer paths
- Revert messages must be clear and specific
- Event must include account and approval status
- Must maintain ERC-20 standard compliance (events, return values)

### Testing

**Test File Location**: `contracts/test/ChainEquityToken.test.ts`

**Test Standards**: 
- Test all allowlist functions
- Test transfer restrictions from both transfer() and transferFrom()
- Test role-based access (only APPROVER_ROLE can modify allowlist)
- Test event emissions

**Testing Frameworks**: 
- Hardhat
- ethers.js v6
- Chai

**Specific Requirements**: 
- Test approveWallet adds address and emits event
- Test revokeWallet removes address and emits event
- Test transfer fails when sender not allowlisted
- Test transfer fails when recipient not allowlisted
- Test transfer succeeds when both allowlisted
- Test transferFrom fails when sender not allowlisted
- Test transferFrom fails when recipient not allowlisted
- Test transferFrom succeeds when both allowlisted
- Test non-APPROVER_ROLE cannot modify allowlist
- Test allowlist view function returns correct status

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Product Owner |
| 2024-12-06 | 1.1 | Implemented allowlist mechanism with transfer restrictions, added comprehensive test suite | Dev Agent |

## Dev Agent Record

### Agent Model Used
Auto (Cursor Agent Router)

### Debug Log References
No debug log entries required - all tests passed successfully

### Completion Notes List
- Added allowlist mapping: `mapping(address => bool) public allowlist`
- Implemented `AllowlistUpdated(address indexed account, bool approved)` event
- Implemented `approveWallet(address account)` function with APPROVER_ROLE access control
- Implemented `revokeWallet(address account)` function with APPROVER_ROLE access control
- Overrode `transfer()` function to check both sender and recipient are allowlisted
- Overrode `transferFrom()` function to check both sender and recipient are allowlisted
- Revert messages: "Sender not allowlisted" and "Recipient not allowlisted"
- Added minimal `mint()` function for testing purposes (requires MINTER_ROLE) - full minting functionality will be in story 2.3
- Created comprehensive test suite with 26 tests (all passing) covering:
  - Allowlist management (approve/revoke wallet)
  - Role-based access control (only APPROVER_ROLE can modify allowlist)
  - Event emissions (AllowlistUpdated event)
  - Transfer restrictions (transfer() and transferFrom())
  - View function (allowlist status check)
- All acceptance criteria met

### File List
- `contracts/src/ChainEquityToken.sol` (modified - added allowlist functionality)
- `contracts/test/ChainEquityToken.test.ts` (modified - added allowlist tests)

## QA Results
_To be populated by QA agent_

