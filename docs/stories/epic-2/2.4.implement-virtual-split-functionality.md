# Story 2.4: Implement Virtual Split Functionality

## Status
Ready for Review

## Story

**As a** contract administrator,
**I want** to implement a virtual split mechanism that multiplies all balances by a factor,
**so that** I can execute stock splits without transferring tokens or modifying individual balances.

## Acceptance Criteria

1. `_multiplier` private state variable implemented (default: 1)
2. `executeSplit(uint256 newMultiplier)` function implemented (requires DEFAULT_ADMIN_ROLE)
3. `balanceOf(address account)` overridden to return base balance * multiplier
4. `totalSupply()` overridden to return base supply * multiplier
5. Base balances stored internally (not multiplied in storage)
6. Split operation only updates multiplier (does not modify individual balances)
7. `SplitExecuted` event emitted when split is executed
8. Split can be executed multiple times (multiplier compounds)

## Tasks / Subtasks

- [x] Implement multiplier storage (AC: 1)
  - [x] Add `uint256 private _multiplier` state variable
  - [x] Initialize to 1 in constructor
- [x] Override balanceOf function (AC: 3, 5)
  - [x] Get base balance from parent ERC20
  - [x] Return base balance * _multiplier
- [x] Override totalSupply function (AC: 4, 5)
  - [x] Get base supply from parent ERC20
  - [x] Return base supply * _multiplier
- [x] Implement executeSplit function (AC: 2, 6, 7)
  - [x] Add `onlyRole(DEFAULT_ADMIN_ROLE)` modifier
  - [x] Update _multiplier to compound with newMultiplier
  - [x] Emit SplitExecuted event
- [x] Define SplitExecuted event (AC: 7)
  - [x] Event signature: `event SplitExecuted(uint256 newMultiplier, uint256 blockNumber)`
- [x] Test virtual split functionality (AC: 3, 4, 6, 8)
  - [x] Test balanceOf returns multiplied value
  - [x] Test totalSupply returns multiplied value
  - [x] Test base balances unchanged after split
  - [x] Test multiple splits compound correctly

## Dev Notes

### Relevant Source Tree Info
- Contract location: `contracts/src/ChainEquityToken.sol`
- Test location: `contracts/test/ChainEquityToken.test.ts`
- Builds on Story 2.1 (contract structure), Story 2.2 (allowlist), Story 2.3 (minting)

### Architecture Decisions
- Virtual split: balances stored at base value, multiplier applied in view functions
- Multiplier stored as private state variable
- Split operation is gas-efficient (only updates one storage variable)
- Multiplier can be set to any value (not just 2x, 3x, etc.)
- Event includes block number for historical tracking

### Key Constraints
- Base balances must remain unchanged in storage (gas efficiency)
- Multiplier must be applied in view functions only
- Must override both balanceOf and totalSupply
- DEFAULT_ADMIN_ROLE required for split execution
- Multiplier should be > 0 (consider validation)

### Testing

**Test File Location**: `contracts/test/ChainEquityToken.test.ts`

**Test Standards**: 
- Test multiplier application in view functions
- Test base balances remain unchanged
- Test split execution and event emission
- Test multiple splits compound correctly

**Testing Frameworks**: 
- Hardhat
- ethers.js v6
- Chai

**Specific Requirements**: 
- Test balanceOf returns base balance * multiplier
- Test totalSupply returns base supply * multiplier
- Test executeSplit updates multiplier and emits event
- Test base balances unchanged after split
- Test multiple splits: execute 2x split, then 3x split = 6x total
- Test split with multiplier = 1 (no change)
- Test only DEFAULT_ADMIN_ROLE can execute split
- Test split event includes correct multiplier and block number

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Product Owner |
| 2024-12-06 | 1.1 | Implemented virtual split functionality with multiplier compounding, added comprehensive test suite | Dev Agent |

## Dev Agent Record

### Agent Model Used
Auto (Cursor Agent Router)

### Debug Log References
No debug log entries required - all tests passed successfully

### Completion Notes List
- Added `uint256 private _multiplier` state variable initialized to 1 in constructor
- Implemented `SplitExecuted(uint256 newMultiplier, uint256 blockNumber)` event
- Overrode `balanceOf()` function to return base balance * multiplier
- Overrode `totalSupply()` function to return base supply * multiplier
- Implemented `executeSplit(uint256 newMultiplier)` function with DEFAULT_ADMIN_ROLE access control
- Multiplier compounds with previous splits (e.g., 2x then 3x = 6x total)
- Added validation: multiplier must be greater than 0
- Base balances remain unchanged in storage (gas-efficient approach)
- Created comprehensive test suite with 9 new tests covering:
  - Multiplied balance and total supply after split
  - Event emission with correct values
  - Base balances unchanged after split
  - Multiple splits compound correctly
  - Split with multiplier = 1 (no change)
  - Access control (only DEFAULT_ADMIN_ROLE can execute)
  - Validation (multiplier must be > 0)
  - Multiplier applied to all balances correctly
- All 43 tests pass successfully (34 from previous stories + 9 new virtual split tests)
- All acceptance criteria met

### File List
- `contracts/src/ChainEquityToken.sol` (modified - added virtual split functionality)
- `contracts/test/ChainEquityToken.test.ts` (modified - added virtual split tests)

## QA Results
_To be populated by QA agent_

