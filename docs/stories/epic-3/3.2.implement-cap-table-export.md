# Story 3.2: Implement Cap-Table Export

## Status
Draft

## Story

**As a** issuer administrator or analyst,
**I want** a cap-table export service that queries blockchain events, calculates token holder balances and ownership percentages, and exports the data in CSV/JSON format,
**so that** I can generate accurate cap-table reports at any point in time (current or historical) with proper precision handling.

## Acceptance Criteria

1. Service can query Transfer events from deployment block to a specified block number
2. Service can query Mint events from deployment block to a specified block number
3. Service can query Burn events from deployment block to a specified block number (if implemented in contract)
4. Service calculates token holder balances by processing events chronologically from deployment block
5. Service calculates ownership percentages using BigNumber division to avoid JavaScript number precision loss
6. Service formats ownership percentages as strings with 6 decimal places precision
7. Service can generate cap-table snapshot for current block (latest state)
8. Service can generate cap-table snapshot for any historical block number (as-of block queries)
9. Service exports cap-table data in CSV format with headers: address, balance, percentage
10. Service exports cap-table data in JSON format with metadata (block number, timestamp, total supply, holders array)
11. CSV/JSON export includes wallet address, balance (as string), and ownership percentage (as string to preserve precision)
12. Service includes rounding discrepancy note in export when percentages don't sum to exactly 100%
13. Service handles edge cases: empty cap-table, single holder, zero total supply
14. Service provides clear error messages for invalid block numbers or contract addresses
15. Implementation follows existing backend patterns and TypeScript standards

## Tasks / Subtasks

- [x] Create event query utilities (AC: 1, 2, 3, 14)
  - [x] Create `backend/src/utils/events.ts` with event query functions
  - [x] Implement `queryTransferEvents(contract, fromBlock, toBlock)` function
  - [x] Implement `queryMintEvents(contract, fromBlock, toBlock)` function
  - [x] Implement `queryBurnEvents(contract, fromBlock, toBlock)` function (if contract supports)
  - [x] Handle event query errors gracefully
- [x] Implement deployment block detection (AC: 1, 2, 3, 8)
  - [x] Create function to get contract deployment block number
  - [x] Query contract deployment transaction to extract block number
  - [x] Cache deployment block for performance
- [x] Implement balance calculation from events (AC: 4, 7, 8, 13)
  - [x] Create `calculateBalancesFromEvents(events, toBlock)` function
  - [x] Process Transfer events chronologically to track balance changes
  - [x] Process Mint events to add to balances
  - [x] Process Burn events to subtract from balances (if applicable)
  - [x] Handle virtual split multiplier for current state queries
  - [x] Return balance map: address -> balance (BigNumber)
- [x] Implement ownership percentage calculation (AC: 5, 6, 12, 13)
  - [x] Create `calculateOwnershipPercentage(balance, totalSupply)` function
  - [x] Use BigNumber for all calculations to avoid precision loss
  - [x] Formula: `(balance * 100 * 1e6) / totalSupply` for 6 decimal precision
  - [x] Format result as decimal string with 6 decimal places using `formatUnits`
  - [x] Calculate sum of all percentages and detect rounding discrepancies
  - [x] Return percentage as string to preserve precision
- [x] Implement cap-table generation function (AC: 7, 8, 11, 13, 14)
  - [x] Update `generateCapTable(contractAddress, blockNumber?)` function in `cap-table.ts`
  - [x] Support optional blockNumber parameter (null = current block)
  - [x] Query deployment block if not provided
  - [x] Query all relevant events up to target block
  - [x] Calculate balances from events
  - [x] Get totalSupply at target block (accounting for virtual split if current)
  - [x] Calculate ownership percentages for all holders
  - [x] Sort holders by balance (descending)
  - [x] Calculate rounding discrepancy if percentages don't sum to 100%
  - [x] Return CapTable interface with metadata
- [x] Implement CSV export function (AC: 9, 11, 12)
  - [x] Create `exportCapTableToCSV(capTable)` function
  - [x] Include headers: address, balance, percentage
  - [x] Format each holder row with address, balance (string), percentage (string)
  - [x] Include metadata comment with block number, timestamp, total supply
  - [x] Include rounding discrepancy note if applicable
  - [x] Return CSV string
- [x] Implement JSON export function (AC: 10, 11, 12)
  - [x] Create `exportCapTableToJSON(capTable)` function
  - [x] Include metadata object: blockNumber, timestamp, totalSupply, roundingNote
  - [x] Include holders array with address, balance (string), percentage (string)
  - [x] Format as properly indented JSON string
  - [x] Return JSON string
- [x] Add error handling and validation (AC: 13, 14)
  - [x] Validate contract address format
  - [x] Validate block number is not in the future
  - [x] Validate block number is not before deployment block
  - [x] Handle empty cap-table case (no holders)
  - [x] Handle zero total supply case
  - [x] Handle single holder case
  - [x] Provide clear error messages for all failure cases
- [x] Update service exports (AC: 15)
  - [x] Ensure cap-table functions are properly exported from `backend/src/index.ts`
  - [x] Export CSV and JSON export functions
  - [x] Verify service follows existing code patterns

## Dev Notes

### Relevant Source Tree Info
- Cap-table service location: `backend/src/cap-table.ts`
- Backend entry point: `backend/src/index.ts`
- Event utilities location: `backend/src/utils/events.ts` (to be created)
- Contract location: `contracts/src/ChainEquityToken.sol`
- TypeChain types location: `contracts/typechain-types/src/ChainEquityToken.ts`
- Backend TypeScript config: `backend/tsconfig.json`
- Backend package.json: `backend/package.json`

### Contract Events Reference
The ChainEquityToken contract emits the following events that the Cap-Table service will query:

**Transfer Events:**
- `Transfer(address indexed from, address indexed to, uint256 value)` - Standard ERC-20 transfer event
- Emitted on: `transfer()`, `transferFrom()`, `mint()`

**Mint Events:**
- Minting uses the Transfer event with `from = address(0)` (zero address)
- Query Transfer events where `from` is zero address to identify mints

**Burn Events:**
- Burning uses the Transfer event with `to = address(0)` (zero address)
- Query Transfer events where `to` is zero address to identify burns
- Note: Contract may not have explicit burn functionality yet

### Balance Calculation Logic
1. Start with empty balance map
2. Process all events chronologically (by block number, then transaction index)
3. For Transfer events:
   - Subtract `value` from `from` address (if not zero address)
   - Add `value` to `to` address (if not zero address)
4. For Mint events (Transfer with `from = address(0)`):
   - Add `value` to `to` address
5. For Burn events (Transfer with `to = address(0)`):
   - Subtract `value` from `from` address
6. For current state queries, apply virtual split multiplier to final balances

### Ownership Percentage Calculation
Following the backend architecture pattern:
```typescript
function calculateOwnershipPercentage(
  balance: ethers.BigNumberish,
  totalSupply: ethers.BigNumberish
): string {
  const balanceBN = ethers.BigNumber.from(balance);
  const totalSupplyBN = ethers.BigNumber.from(totalSupply);
  
  // Formula: (balance / totalSupply) * 100
  // To avoid precision loss, scale up before division:
  // (balance * 100 * 1e6) / totalSupply = percentage * 1e6
  const PRECISION = ethers.BigNumber.from(10).pow(6); // 6 decimal places
  const percentageScaled = balanceBN
    .mul(100)                    // Convert to percentage
    .mul(PRECISION)              // Scale for 6 decimal precision
    .div(totalSupplyBN);         // Divide by total supply
  
  // Format as decimal string: percentageScaled / 1e6
  // Example: 10000000 / 1e6 = "10.000000" (10%)
  const percentage = ethers.utils.formatUnits(percentageScaled, 6);
  
  return percentage;
}
```

### Virtual Split Multiplier Handling
- The contract applies a virtual split multiplier to `balanceOf()` and `totalSupply()` view functions
- For current state queries: Use contract's `balanceOf()` and `totalSupply()` which already include multiplier
- For historical block queries: Calculate base balances from events, then apply multiplier if querying current block
- For historical blocks before split: Use base balances without multiplier

### CSV Export Format
```csv
# Cap-Table Export
# Block Number: 12345
# Timestamp: 2024-01-01T00:00:00Z
# Total Supply: 1000000
# Note: Percentages may not sum to exactly 100% due to rounding

address,balance,percentage
0x1234...,500000,50.000000
0x5678...,300000,30.000000
0x9abc...,200000,20.000000
```

### JSON Export Format
```json
{
  "metadata": {
    "blockNumber": 12345,
    "timestamp": "2024-01-01T00:00:00Z",
    "totalSupply": "1000000",
    "roundingNote": "Percentages may not sum to exactly 100% due to rounding"
  },
  "holders": [
    {
      "address": "0x1234...",
      "balance": "500000",
      "percentage": "50.000000"
    },
    {
      "address": "0x5678...",
      "balance": "300000",
      "percentage": "30.000000"
    },
    {
      "address": "0x9abc...",
      "balance": "200000",
      "percentage": "20.000000"
    }
  ]
}
```

### Environment Variables Needed
- `CONTRACT_ADDRESS` - ChainEquityToken contract address (if not passed as parameter)
- `RPC_URL` - Blockchain RPC endpoint URL (from provider utility)

### Integration Points
- Uses ethers.js v6.x for blockchain interaction
- Uses TypeChain generated types for type safety
- Uses provider utility from Story 3.1 (or creates if not available)
- Follows existing backend TypeScript patterns
- Service will be used by CLI tools or API endpoints (future stories)

### Testing
- Test file location: `backend/src/__tests__/cap-table.test.ts` (to be created in future story)
- Testing standards: Unit tests for each function, integration tests with local Hardhat node
- Test scenarios:
  - Empty cap-table (no events)
  - Single holder
  - Multiple holders
  - Historical block queries
  - Current block queries
  - Rounding discrepancy detection
  - Edge cases (zero supply, etc.)
- Use Hardhat local node for integration testing with actual contract events

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Auto (Cursor AI)

### Debug Log References
N/A

### Completion Notes List
- Created event query utilities for Transfer, Mint, and Burn events
- Implemented deployment block detection using contract events
- Implemented balance calculation from events with chronological processing
- Implemented ownership percentage calculation with BigNumber precision (6 decimal places)
- Implemented cap-table generation function supporting current and historical block queries
- Implemented CSV and JSON export functions with metadata
- Added comprehensive error handling and validation for all edge cases
- All code compiles successfully and follows TypeScript standards

### File List
- `backend/src/utils/events.ts` - Event query utilities
- `backend/src/utils/deployment.ts` - Deployment block detection
- `backend/src/utils/balances.ts` - Balance calculation from events
- `backend/src/utils/percentage.ts` - Ownership percentage calculation
- `backend/src/cap-table.ts` - Cap-table generation and export functions
- `backend/src/index.ts` - Updated exports

## QA Results
_To be populated by QA agent_

