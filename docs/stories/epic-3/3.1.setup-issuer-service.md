# Story 3.1: Setup Issuer Service

## Status
Draft

## Story

**As a** issuer administrator,
**I want** an issuer service that can approve/deny wallet addresses, submit allowlist updates to the contract, mint tokens to approved wallets, query allowlist status, and trigger corporate actions,
**so that** I can manage token operations and perform administrative functions through a backend service.

## Acceptance Criteria

1. Service can approve wallet addresses (add to allowlist) via contract's `approveWallet` function
2. Service can deny wallet addresses (remove from allowlist) via contract's `revokeWallet` function
3. Service can query allowlist status for any wallet address
4. Service can mint tokens to approved wallets via contract's `mint` function
5. Service can trigger virtual split corporate action via contract's `executeSplit` function
6. Service can change token symbol via contract's `changeSymbol` function
7. All operations require appropriate role-based access (APPROVER_ROLE for allowlist, MINTER_ROLE for minting, DEFAULT_ADMIN_ROLE for corporate actions)
8. Service handles transaction confirmation and error handling
9. Service provides clear error messages for failed operations
10. Implementation follows existing backend patterns and TypeScript standards

## Tasks / Subtasks

- [x] Create blockchain provider utility (AC: 1-10)
  - [x] Create `backend/src/utils/provider.ts` with `getProvider()` function
  - [x] Support environment variable configuration for RPC URL
  - [x] Support both local and remote blockchain connections
- [x] Create contract interaction utilities (AC: 1-10)
  - [x] Create `backend/src/utils/contract.ts` with contract instance creation
  - [x] Support contract address configuration via environment variable
  - [x] Load contract ABI from TypeChain generated types
- [x] Implement allowlist management functions (AC: 1, 2, 3, 7, 8, 9)
  - [x] Implement `approveWallet(address)` method in IssuerService class
  - [x] Implement `revokeWallet(address)` method in IssuerService class
  - [x] Implement `isAllowlisted(address)` query method
  - [x] Verify APPROVER_ROLE before allowlist operations
  - [x] Handle transaction confirmation and errors
- [x] Implement minting functionality (AC: 4, 7, 8, 9)
  - [x] Implement `mintTokens(address, amount)` method in IssuerService class
  - [x] Verify MINTER_ROLE before minting
  - [x] Verify recipient is allowlisted before minting
  - [x] Handle transaction confirmation and errors
- [x] Implement corporate action functions (AC: 5, 6, 7, 8, 9)
  - [x] Implement `executeSplit(multiplier)` method in IssuerService class
  - [x] Implement `changeSymbol(newSymbol)` method in IssuerService class
  - [x] Verify DEFAULT_ADMIN_ROLE before corporate actions
  - [x] Handle transaction confirmation and errors
- [x] Add error handling and validation (AC: 8, 9)
  - [x] Validate wallet addresses format
  - [x] Validate amounts are positive numbers
  - [x] Provide clear error messages for role-based access failures
  - [x] Handle network errors and transaction failures gracefully
- [x] Update service exports (AC: 10)
  - [x] Ensure IssuerService is properly exported from `backend/src/index.ts`
  - [x] Verify service follows existing code patterns

## Dev Notes

### Relevant Source Tree Info
- Backend service location: `backend/src/issuer.ts`
- Backend entry point: `backend/src/index.ts`
- Contract location: `contracts/src/ChainEquityToken.sol`
- TypeChain types location: `contracts/typechain-types/src/ChainEquityToken.ts`
- Backend TypeScript config: `backend/tsconfig.json`
- Backend package.json: `backend/package.json`

### Contract Functions Reference
The ChainEquityToken contract provides the following functions that the Issuer Service will interact with:

**Allowlist Management:**
- `approveWallet(address account)` - Requires APPROVER_ROLE, adds address to allowlist
- `revokeWallet(address account)` - Requires APPROVER_ROLE, removes address from allowlist
- `allowlist(address account) public view returns (bool)` - Query allowlist status

**Minting:**
- `mint(address to, uint256 amount)` - Requires MINTER_ROLE, mints tokens to allowlisted address

**Corporate Actions:**
- `executeSplit(uint256 newMultiplier)` - Requires DEFAULT_ADMIN_ROLE, executes virtual split
- `changeSymbol(string memory newSymbol)` - Requires DEFAULT_ADMIN_ROLE, changes token symbol

**Access Control:**
- Contract uses OpenZeppelin AccessControl with roles:
  - `APPROVER_ROLE` - For allowlist management
  - `MINTER_ROLE` - For minting tokens
  - `DEFAULT_ADMIN_ROLE` - For corporate actions

### Implementation Pattern
Following the backend architecture pattern:
```typescript
// Example structure for IssuerService
export class IssuerService {
  private contract: ethers.Contract;
  private signer: ethers.Signer;
  
  constructor(contractAddress: string, signer: ethers.Signer) {
    // Initialize contract instance
  }
  
  async approveWallet(address: string): Promise<string> {
    // Implementation
  }
  
  // Other methods...
}
```

### Environment Variables Needed
- `CONTRACT_ADDRESS` - ChainEquityToken contract address
- `RPC_URL` - Blockchain RPC endpoint URL
- `PRIVATE_KEY` - Private key for signer (for operations requiring roles)

### Integration Points
- Uses ethers.js v6.x for blockchain interaction
- Uses TypeChain generated types for type safety
- Follows existing backend TypeScript patterns
- Service will be used by CLI tools or API endpoints (future stories)

### Testing
- Test file location: `backend/src/__tests__/issuer.test.ts` (to be created in future story)
- Testing standards: Unit tests for each method, integration tests with local Hardhat node
- Mock contract interactions for unit tests
- Use Hardhat local node for integration testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Auto (Cursor AI)

### Debug Log References
N/A

### Completion Notes List
- Created blockchain provider utility with environment variable support
- Created contract interaction utilities using TypeChain types
- Implemented IssuerService class with all required methods:
  - Allowlist management (approveWallet, revokeWallet, isAllowlisted)
  - Minting functionality with role and allowlist verification
  - Corporate actions (executeSplit, changeSymbol)
- All methods include proper role verification and error handling
- Fixed TypeScript configuration to properly handle typechain-types imports
- All code compiles successfully with strict TypeScript settings

### File List
- `backend/src/utils/provider.ts` - Blockchain provider utility
- `backend/src/utils/contract.ts` - Contract interaction utilities
- `backend/src/issuer.ts` - IssuerService class implementation
- `backend/src/index.ts` - Updated exports
- `backend/tsconfig.json` - Updated TypeScript configuration

## QA Results
_To be populated by QA agent_

