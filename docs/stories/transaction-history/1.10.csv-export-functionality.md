# Story 1.10: CSV Export Functionality

## Status
Draft

## Story

**As a** user,
**I want** to export filtered transaction history to CSV,
**so that** I can analyze transaction data in external tools.

## Acceptance Criteria

1. Add "Export CSV" button to filter section
2. Export only currently filtered transactions (respects all active filters: address, transaction type, date range)
3. Generate CSV file client-side using JavaScript
4. Include all transaction fields: hash, type, blockNumber, timestamp, from, to, amount, event-specific data
5. Format timestamps in ISO 8601 format (YYYY-MM-DDTHH:mm:ssZ)
6. Format addresses in lowercase with 0x prefix
7. Format amounts with appropriate decimal precision
8. Trigger download using browser download API
9. Use descriptive filename (e.g., "chain-equity-transactions-YYYY-MM-DD.csv")
10. Display loading state during CSV generation
11. Show success feedback when download initiates
12. Handle errors gracefully (e.g., too many transactions, browser download restrictions)
13. Support exporting up to 10,000 transactions within 10 seconds

## Tasks / Subtasks

- [ ] Add export button (AC: 1)
  - [ ] Add "Export CSV" button to filter section
  - [ ] Position button in filter area
  - [ ] Style button according to design system
  - [ ] Disable button when no transactions to export
- [ ] Implement filtered export (AC: 2)
  - [ ] Export only currently filtered transactions
  - [ ] Respect all active filters (address, transaction type, date range)
  - [ ] Query filtered transactions if not already loaded
  - [ ] Handle large filtered datasets
- [ ] Implement CSV generation (AC: 3, 4, 5, 6, 7)
  - [ ] Generate CSV file client-side using JavaScript
  - [ ] Include all transaction fields: hash, type, blockNumber, timestamp, from, to, amount, event-specific data
  - [ ] Format timestamps in ISO 8601 format
  - [ ] Format addresses in lowercase with 0x prefix
  - [ ] Format amounts with appropriate decimal precision
  - [ ] Create `frontend/src/utils/csvExport.ts` for CSV generation utilities
- [ ] Implement download trigger (AC: 8, 9)
  - [ ] Trigger download using browser download API
  - [ ] Use descriptive filename with date (e.g., "chain-equity-transactions-2024-12-19.csv")
  - [ ] Handle browser download restrictions
- [ ] Implement loading state (AC: 10)
  - [ ] Display loading state during CSV generation
  - [ ] Show progress indicator for large datasets
  - [ ] Disable export button during generation
- [ ] Implement success feedback (AC: 11)
  - [ ] Show success toast notification when download initiates
  - [ ] Auto-dismiss after 5 seconds
  - [ ] Use existing toast component from design system
- [ ] Implement error handling (AC: 12)
  - [ ] Handle too many transactions error
  - [ ] Handle browser download restrictions
  - [ ] Show user-friendly error messages
  - [ ] Provide retry option
- [ ] Optimize for large datasets (AC: 13)
  - [ ] Stream CSV generation for large datasets (generate in chunks)
  - [ ] Support exporting up to 10,000 transactions within 10 seconds
  - [ ] Show progress indicator for long-running exports
  - [ ] Consider backend export service for datasets > 5,000 transactions

## Dev Notes

### Relevant Source Tree Info
- CSV export utilities: `frontend/src/utils/csvExport.ts`
- Transaction filters component: `frontend/src/components/TransactionHistory/TransactionFilters.tsx`
- Transaction history hook: `frontend/src/hooks/useTransactionHistory.ts` (from Story 1.1)

### CSV Generation Implementation
**CSV Format:**
```csv
hash,type,blockNumber,timestamp,from,to,amount,eventData
0x1234...,Transfer,12345,2024-12-19T15:45:00Z,0xabcd...,0xefgh...,1000.0,
0x5678...,Mint,12346,2024-12-19T15:46:00Z,,0xijkl...,5000.0,
0x9abc...,Split,12347,2024-12-19T15:47:00Z,,,,"{""multiplier"":7}"
```

**CSV Generation Function:**
```typescript
function generateCSV(transactions: Transaction[]): string {
  const headers = ['hash', 'type', 'blockNumber', 'timestamp', 'from', 'to', 'amount', 'eventData'];
  
  const rows = transactions.map(tx => [
    tx.hash.toLowerCase(),
    tx.type,
    tx.blockNumber.toString(),
    formatTimestampISO(tx.timestamp),
    tx.from?.toLowerCase() || '',
    tx.to?.toLowerCase() || '',
    tx.amount || '',
    JSON.stringify(tx.eventData)
  ]);
  
  return [headers, ...rows]
    .map(row => row.map(cell => `"${cell}"`).join(','))
    .join('\n');
}
```

### Timestamp Formatting
```typescript
function formatTimestampISO(timestamp: number): string {
  const date = new Date(timestamp * 1000); // Convert Unix seconds to milliseconds
  return date.toISOString(); // Returns: "2024-12-19T15:45:00.000Z"
}
```

### Address Formatting
```typescript
function formatAddressForCSV(address: string | null): string {
  if (!address) return '';
  return address.toLowerCase(); // Ensure lowercase with 0x prefix
}
```

### Amount Formatting
```typescript
function formatAmountForCSV(amount: string | null, decimals: number): string {
  if (!amount) return '';
  // Format with appropriate decimal precision
  return parseFloat(amount).toFixed(decimals);
}
```

### Download Implementation
```typescript
function downloadCSV(csvContent: string, filename: string): void {
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  URL.revokeObjectURL(url);
}
```

### Filename Generation
```typescript
function generateFilename(): string {
  const date = new Date();
  const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
  return `chain-equity-transactions-${dateStr}.csv`;
}
```

### Streaming for Large Datasets
- Generate CSV in chunks for large datasets
- Use Blob API with streaming
- Show progress indicator
- Consider Web Workers for very large datasets

### Error Handling
- **Too many transactions**: Show warning, suggest filtering
- **Browser download restrictions**: Show error message with instructions
- **Memory issues**: Stream generation, show progress
- **Network errors**: Show retry option

### Integration Points
- Uses `TransactionFilters` component
- Uses `useTransactionHistory` hook from Story 1.1
- Uses existing toast component from design system
- Follows existing frontend patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

_To be populated when story is implemented_

## QA Results

_To be populated by QA agent_




