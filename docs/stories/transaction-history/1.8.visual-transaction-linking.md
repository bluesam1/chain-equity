# Story 1.8: Visual Transaction Linking

## Status
Draft

## Story

**As a** user,
**I want** to see visual connections between related send and receive transactions,
**so that** I can understand transaction relationships and flows.

## Acceptance Criteria

1. Group transactions by transaction hash (same hash = related transactions)
2. Identify related send/receive transactions that share the same transaction hash
3. Draw connecting lines between related transactions using SVG or CSS
4. Position connecting lines dynamically based on transaction row positions
5. Use subtle color (gray or primary blue) for connecting lines to avoid cluttering interface
6. Ensure connecting lines are visible and don't overlap with transaction content
7. Handle edge cases: transactions spanning multiple pages, single transactions without pairs
8. Make connecting lines responsive (adjust on window resize)
9. Ensure connecting lines don't interfere with clickable addresses or transaction rows
10. Optimize line rendering performance for large transaction lists

## Tasks / Subtasks

- [ ] Implement transaction grouping (AC: 1, 2)
  - [ ] Group transactions by transaction hash
  - [ ] Identify related send/receive transactions
  - [ ] Only link Transfer events (send/receive pairs)
  - [ ] Handle transactions with multiple Transfer events (batch transfers)
- [ ] Create connecting lines component (AC: 3, 4, 5)
  - [ ] Create `frontend/src/components/TransactionHistory/ConnectingLines.tsx`
  - [ ] Draw connecting lines using SVG or CSS
  - [ ] Position lines dynamically based on transaction row positions
  - [ ] Use subtle color (Blue-400 #60A5FA with 50% opacity)
  - [ ] Use curved bezier path for smooth curves
- [ ] Implement line positioning (AC: 4, 8)
  - [ ] Calculate line positions based on transaction row positions
  - [ ] Use getBoundingClientRect() to get row positions
  - [ ] Adjust line positions on window resize
  - [ ] Use ResizeObserver or window resize event
- [ ] Handle edge cases (AC: 7)
  - [ ] Handle transactions spanning multiple pages
  - [ ] Handle single transactions without pairs
  - [ ] Hide lines for transactions without pairs
  - [ ] Show lines only for visible transactions
- [ ] Optimize performance (AC: 10)
  - [ ] Only render connecting lines for visible transactions (viewport culling)
  - [ ] Use requestAnimationFrame for smooth rendering
  - [ ] Debounce line position calculations on scroll
  - [ ] Consider using Canvas instead of SVG for very large lists
- [ ] Ensure accessibility (AC: 9)
  - [ ] Ensure lines don't interfere with clickable addresses
  - [ ] Ensure lines don't interfere with transaction row clicks
  - [ ] Use pointer-events: none on lines
  - [ ] Position lines behind transaction rows (z-index)

## Dev Notes

### Relevant Source Tree Info
- Connecting lines component: `frontend/src/components/TransactionHistory/ConnectingLines.tsx`
- Transaction list component: `frontend/src/components/TransactionHistory/TransactionList.tsx` (from Story 1.2)
- Transaction row component: `frontend/src/components/TransactionHistory/TransactionRow.tsx` (from Story 1.2)

### Transaction Grouping Logic
**Group by Transaction Hash:**
```typescript
// Group transactions by hash
const transactionsByHash = new Map<string, Transaction[]>();

transactions.forEach(tx => {
  if (!transactionsByHash.has(tx.hash)) {
    transactionsByHash.set(tx.hash, []);
  }
  transactionsByHash.get(tx.hash)!.push(tx);
});

// Only link Transfer events (send/receive pairs)
const transferPairs = Array.from(transactionsByHash.values())
  .filter(group => group.some(tx => tx.type === 'Transfer'))
  .map(group => group.filter(tx => tx.type === 'Transfer'));
```

### Connecting Lines Implementation
**SVG Overlay:**
```typescript
// Create SVG overlay positioned absolutely
<svg className="absolute inset-0 pointer-events-none" style={{ zIndex: 1 }}>
  {transferPairs.map(pair => {
    if (pair.length === 2) {
      // Draw line between two transactions
      const fromRow = document.getElementById(`tx-${pair[0].hash}`);
      const toRow = document.getElementById(`tx-${pair[1].hash}`);
      
      if (fromRow && toRow) {
        const fromRect = fromRow.getBoundingClientRect();
        const toRect = toRow.getBoundingClientRect();
        
        // Calculate bezier curve path
        const path = `M ${fromRect.left + fromRect.width / 2} ${fromRect.top + fromRect.height / 2}
                     C ${fromRect.left + fromRect.width / 2} ${(fromRect.top + toRect.top) / 2}
                       ${toRect.left + toRect.width / 2} ${(fromRect.top + toRect.top) / 2}
                       ${toRect.left + toRect.width / 2} ${toRect.top + toRect.height / 2}`;
        
        return <path key={pair[0].hash} d={path} stroke="#60A5FA" strokeWidth="2" fill="none" opacity="0.5" />;
      }
    }
    return null;
  })}
</svg>
```

**Line Styling:**
- Color: Blue-400 (#60A5FA) with 50% opacity
- Stroke width: 2px
- Style: Curved bezier path
- Z-index: Behind transaction rows but above background

### Viewport Culling
- Only render lines for visible transactions
- Use Intersection Observer to detect visible rows
- Recalculate line positions on scroll
- Hide lines for transactions outside viewport

### Performance Optimization
- Use requestAnimationFrame for smooth rendering
- Debounce line position calculations on scroll
- Cache line positions when possible
- Consider using Canvas for very large lists (>1000 visible transactions)

### Responsive Design
- Adjust line curve radius on smaller screens
- Simplify lines on mobile (straight lines instead of curves)
- Hide lines on very small screens if needed

### Integration Points
- Extends `TransactionList` component from Story 1.2
- Uses `TransactionRow` component from Story 1.2
- Integrates with virtual paging from Story 1.3
- Follows existing frontend patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

_To be populated when story is implemented_

## QA Results

_To be populated by QA agent_



