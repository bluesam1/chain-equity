# Story 1.1: Event Querying Infrastructure

## Status
Ready for Review

## Story

**As a** developer,
**I want** to implement event querying infrastructure that retrieves all blockchain events from the ChainEquityToken contract,
**so that** we can display transaction history to users.

## Acceptance Criteria

1. Create a custom React hook `useTransactionHistory` that queries blockchain events using ethers.js (following same pattern as `useCapTable`)
2. Use `getContractDeploymentBlock()` utility from `frontend/src/lib/blockLookup.ts` to get deployment block (same as cap table)
3. Use `contract.queryFilter()` method with block ranges (fromBlock, toBlock) - same pattern as cap table
4. Query relevant events: Transfer, SplitExecuted, SymbolChanged, AllowlistUpdated using block ranges
5. For date range filters: Convert dates to block numbers FIRST using `findBlockByTimestamp()` utility, then use those blocks as query range
6. Process events chronologically (by block number, then transaction index)
7. Convert events to transaction objects with standardized structure: hash, type, blockNumber, timestamp, from, to, amount, event-specific data
8. Identify transaction types correctly:
   - Transfer: Standard Transfer events
   - Mint: Transfer events where from = zero address
   - Burn: Transfer events where to = zero address
   - Split: SplitExecuted events
   - SymbolChange: SymbolChanged events
   - AllowlistUpdate: AllowlistUpdated events
9. Convert block numbers to timestamps using provider.getBlock() ONLY for display (cache aggressively)
10. Handle errors gracefully with user-friendly error messages (same error handling pattern as cap table)
11. Implement loading states during event querying
12. Cache block timestamps to avoid redundant getBlock() calls
13. Support querying events in reverse chronological order (newest first) using virtual paging
14. Process events in batches (similar to cap table's batchSize = 10) to avoid overwhelming RPC provider

## Tasks / Subtasks

- [x] Create useTransactionHistory hook (AC: 1, 2, 3)
  - [x] Create `frontend/src/hooks/useTransactionHistory.ts`
  - [x] Use `getContractDeploymentBlock()` utility from `blockLookup.ts`
  - [x] Use `contract.queryFilter()` method with block ranges
  - [x] Follow same pattern as `useCapTable` hook
- [x] Implement event querying (AC: 4, 5, 6)
  - [x] Query Transfer events using block ranges
  - [x] Query SplitExecuted events using block ranges
  - [x] Query SymbolChanged events using block ranges
  - [x] Query AllowlistUpdated events using block ranges
  - [x] Implement date-to-block conversion using `findBlockByTimestamp()` utility
  - [x] Process events chronologically (by block number, then transaction index)
- [x] Implement transaction type identification (AC: 8)
  - [x] Identify Transfer events (standard transfers)
  - [x] Identify Mint events (Transfer with from = zero address)
  - [x] Identify Burn events (Transfer with to = zero address)
  - [x] Identify Split events (SplitExecuted events)
  - [x] Identify SymbolChange events (SymbolChanged events)
  - [x] Identify AllowlistUpdate events (AllowlistUpdated events)
- [x] Implement transaction object conversion (AC: 7)
  - [x] Convert events to standardized transaction structure
  - [x] Include: hash, type, blockNumber, timestamp, from, to, amount, event-specific data
  - [x] Extract event-specific data (split multiplier, symbol changes, allowlist status)
- [x] Implement block timestamp conversion (AC: 9, 12)
  - [x] Convert block numbers to timestamps using provider.getBlock()
  - [x] Cache block timestamps aggressively (blocks don't change)
  - [x] Only convert timestamps for display purposes
  - [x] Store timestamp cache in component state or localStorage
- [x] Implement error handling (AC: 10)
  - [x] Handle network errors gracefully
  - [x] Handle invalid block numbers
  - [x] Handle contract not found errors
  - [x] Provide user-friendly error messages
  - [x] Follow same error handling pattern as cap table
- [x] Implement loading states (AC: 11)
  - [x] Show loading state during initial event query
  - [x] Show loading state during date-to-block conversion
  - [x] Show loading state during pagination
- [x] Implement virtual paging support (AC: 13)
  - [x] Support querying events in reverse chronological order
  - [x] Calculate block ranges for pagination
  - [x] Query only current page's block range
- [x] Implement batch processing (AC: 14)
  - [x] Process events in batches (similar to cap table's batchSize = 10)
  - [x] Avoid overwhelming RPC provider
  - [x] Handle batch processing errors gracefully

## Dev Notes

### Relevant Source Tree Info
- Transaction history hook: `frontend/src/hooks/useTransactionHistory.ts`
- Block lookup utilities: `frontend/src/lib/blockLookup.ts`
- Cap table hook reference: `frontend/src/hooks/useCapTable.ts`
- Contract location: `contracts/src/ChainEquityToken.sol`
- Contract address utility: `frontend/src/lib/contract.ts`

### Contract Events Reference
The ChainEquityToken contract emits the following events:

**Transfer Events:**
- `Transfer(address indexed from, address indexed to, uint256 value)` - Standard ERC-20 transfer event
- Emitted on: `transfer()`, `transferFrom()`, `mint()`
- Mint: Transfer with `from = address(0)` (zero address)
- Burn: Transfer with `to = address(0)` (zero address)

**SplitExecuted Events:**
- `SplitExecuted(uint256 newMultiplier, uint256 blockNumber)` - Corporate action event
- Emitted on: `executeSplit()`

**SymbolChanged Events:**
- `SymbolChanged(string oldSymbol, string newSymbol)` - Corporate action event
- Emitted on: `changeSymbol()`

**AllowlistUpdated Events:**
- `AllowlistUpdated(address indexed account, bool approved)` - Allowlist management event
- Emitted on: `approveWallet()`, `removeWallet()`

### Transaction Data Structure
```typescript
interface Transaction {
  hash: string;              // Transaction hash
  type: TransactionType;     // Transfer, Mint, Burn, Split, SymbolChange, AllowlistUpdate
  blockNumber: number;       // Block number
  timestamp: number;         // Block timestamp (Unix seconds)
  from: string | null;       // From address (if applicable)
  to: string | null;         // To address (if applicable)
  amount: string | null;     // Amount/value (if applicable)
  eventData: {               // Event-specific data
    // For Split: { multiplier: number }
    // For SymbolChange: { oldSymbol: string, newSymbol: string }
    // For AllowlistUpdate: { account: string, approved: boolean }
    [key: string]: unknown;
  };
}
```

### Virtual Paging Strategy
- Calculate block range for current page based on estimated events per block
- Query events only for current page's block range (fromBlock to toBlock)
- For reverse chronological order: Start from current block, work backwards
- Estimate: ~50 events per page, ~10 events per block = ~5 blocks per page
- Cache block ranges that have been queried

### Batch Processing
- Process events in batches (batchSize = 10) to avoid overwhelming RPC provider
- Similar to cap table implementation pattern
- Handle batch processing errors gracefully

### Error Handling Pattern
Follow same error handling pattern as cap table:
- Handle CALL_EXCEPTION for invalid block numbers
- Handle network errors with retry option
- Provide user-friendly error messages
- Validate block numbers before querying

### Integration Points
- Uses ethers.js v6.x for blockchain interaction
- Uses `getContractDeploymentBlock()` from `blockLookup.ts`
- Uses `findBlockByTimestamp()` from `blockLookup.ts` for date filtering
- Uses `getContractAddress()` from `contract.ts`
- Follows same pattern as `useCapTable` hook

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes
- Created `useTransactionHistory` hook following the same pattern as `useCapTable`
- Implemented event querying for all 4 event types (Transfer, SplitExecuted, SymbolChanged, AllowlistUpdated)
- Implemented transaction type identification with proper handling of Mint/Burn from Transfer events
- Implemented block timestamp caching using useRef to avoid redundant getBlock() calls
- Implemented date-to-block conversion using `findBlockByTimestamp()` utility
- Implemented batch processing with batchSize = 10 to avoid overwhelming RPC provider
- Implemented virtual paging support with reverse chronological order (newest first)
- Implemented error handling following the same pattern as cap table (CALL_EXCEPTION handling, network errors, etc.)
- All acceptance criteria met

### File List
- `frontend/src/hooks/useTransactionHistory.ts` (created)

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | John (PM) |
| 2024-12-19 | 1.1 | Story implementation completed | James (Dev) |

## QA Results

_To be populated by QA agent_

