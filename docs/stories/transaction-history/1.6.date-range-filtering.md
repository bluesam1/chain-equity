# Story 1.6: Date Range Filtering

## Status
Draft

## Story

**As a** user,
**I want** to filter transactions by date range,
**so that** I can view transactions within a specific time period.

## Acceptance Criteria

1. Add date range filter with start date and end date pickers
2. Convert start date and end date to block numbers FIRST using `findBlockByTimestamp()` utility from `frontend/src/lib/blockLookup.ts`
3. Show loading state during date-to-block conversion (binary search can take a few seconds)
4. Use calculated block numbers as fromBlock/toBlock in event query (query only that block range)
5. Validate date range (start date must be before end date)
6. Validate that dates are not before contract deployment or in the future
7. Show validation error for invalid date ranges
8. Apply date range filter by recalculating block range and requerying events
9. Clear date range filter functionality (reset to deployment block to current block)
10. Display active filter indicator when date range filter is applied
11. Update transaction count to reflect filtered results
12. Combine date range filter with address and transaction type filters (AND logic) - all filters applied at query level
13. Support deep linking: URL parameters `?startDate=2024-01-01&endDate=2024-12-31` apply date range filter (convert to blocks on load)
14. Use lightweight date picker library (e.g., react-datepicker) or HTML5 date inputs
15. Cache date-to-block conversions to avoid redundant binary searches

## Tasks / Subtasks

- [ ] Create date range filter component (AC: 1, 14)
  - [ ] Create `frontend/src/components/TransactionHistory/DateRangeFilter.tsx`
  - [ ] Add start date and end date pickers
  - [ ] Use react-datepicker library or HTML5 date inputs
  - [ ] Style date pickers according to design system
- [ ] Implement date-to-block conversion (AC: 2, 3, 4)
  - [ ] Use `findBlockByTimestamp()` utility from `blockLookup.ts`
  - [ ] Convert start date to block number (fromBlock)
  - [ ] Convert end date to block number (toBlock)
  - [ ] Show loading state during conversion (binary search can take a few seconds)
  - [ ] Use calculated block numbers as fromBlock/toBlock in event query
  - [ ] Query events only within calculated block range
- [ ] Implement date validation (AC: 5, 6, 7)
  - [ ] Validate start date is before end date
  - [ ] Validate dates are not before contract deployment
  - [ ] Validate dates are not in the future
  - [ ] Show validation errors for invalid date ranges
  - [ ] Use `getContractDeploymentBlock()` to get deployment block
  - [ ] Use current block timestamp to validate future dates
- [ ] Implement filter application (AC: 8)
  - [ ] Recalculate block range when date range changes
  - [ ] Requery events with new block range
  - [ ] Show loading state during requery
- [ ] Implement filter clearing (AC: 9)
  - [ ] Add "Clear" button to date range filter
  - [ ] Clear date inputs when clicked
  - [ ] Reset filter to deployment block to current block
- [ ] Implement active filter indicator (AC: 10)
  - [ ] Display visual indicator when date range filter is applied
  - [ ] Show filter badge or chip with date range
  - [ ] Format date range display (e.g., "Jan 1 - Dec 31, 2024")
- [ ] Update transaction count (AC: 11)
  - [ ] Update transaction count to reflect filtered results
  - [ ] Show count in transaction count indicator
- [ ] Combine with other filters (AC: 12)
  - [ ] Apply date range filter with address and transaction type filters
  - [ ] Use AND logic (all active filters must match)
  - [ ] Apply all filters at query level
- [ ] Implement deep linking (AC: 13)
  - [ ] Parse URL parameters `?startDate=2024-01-01&endDate=2024-12-31` on page load
  - [ ] Convert dates to blocks on load
  - [ ] Automatically apply date range filter from URL parameters
  - [ ] Update URL when date range filter changes
- [ ] Implement caching (AC: 15)
  - [ ] Cache date-to-block conversions
  - [ ] Store cache in component state or localStorage
  - [ ] Avoid redundant binary searches for same dates

## Dev Notes

### Relevant Source Tree Info
- Date range filter component: `frontend/src/components/TransactionHistory/DateRangeFilter.tsx`
- Transaction filters component: `frontend/src/components/TransactionHistory/TransactionFilters.tsx`
- Block lookup utilities: `frontend/src/lib/blockLookup.ts`
- Transaction history hook: `frontend/src/hooks/useTransactionHistory.ts` (from Story 1.1)

### Date-to-Block Conversion
**Using findBlockByTimestamp Utility:**
```typescript
import { findBlockByTimestamp } from '../lib/blockLookup';

// Convert start date to block number
const startTimestamp = Math.floor(startDate.getTime() / 1000); // Unix seconds
const startBlockResult = await findBlockByTimestamp(provider, startTimestamp);
const fromBlock = startBlockResult.blockNumber;

// Convert end date to block number
const endTimestamp = Math.floor(endDate.getTime() / 1000); // Unix seconds
const endBlockResult = await findBlockByTimestamp(provider, endTimestamp);
const toBlock = endBlockResult.blockNumber;

// Use fromBlock/toBlock in event query
const events = await contract.queryFilter(filter, fromBlock, toBlock);
```

**Loading State:**
- Binary search can take a few seconds for large block ranges
- Show loading spinner during conversion
- Display progress if possible (using progressCallback)

### Date Validation
```typescript
// Validate start date is before end date
if (startDate >= endDate) {
  throw new Error('Start date must be before end date');
}

// Validate dates are not before contract deployment
const deploymentBlock = await getContractDeploymentBlock(provider, contractAddress);
const deploymentBlockData = await provider.getBlock(deploymentBlock);
const deploymentTimestamp = deploymentBlockData.timestamp;
if (startDate.getTime() / 1000 < deploymentTimestamp) {
  throw new Error('Start date cannot be before contract deployment');
}

// Validate dates are not in the future
const currentBlock = await provider.getBlockNumber();
const currentBlockData = await provider.getBlock(currentBlock);
const currentTimestamp = currentBlockData.timestamp;
if (endDate.getTime() / 1000 > currentTimestamp) {
  throw new Error('End date cannot be in the future');
}
```

### Date Range Filter State
```typescript
interface DateRangeFilterState {
  startDate: Date | null;
  endDate: Date | null;
  fromBlock: number | null;
  toBlock: number | null;
  isLoading: boolean;
  error: string | null;
}
```

### Caching Strategy
- Cache date-to-block conversions in component state
- Key: `${startTimestamp}-${endTimestamp}`
- Store in localStorage for persistence
- Clear cache when contract address changes

### Deep Linking Format
- URL parameters: `?startDate=2024-01-01&endDate=2024-12-31`
- Parse dates from URL on component mount
- Convert to blocks on load
- Apply filter automatically

### Integration Points
- Uses `findBlockByTimestamp()` from `blockLookup.ts`
- Uses `getContractDeploymentBlock()` from `blockLookup.ts`
- Extends `useTransactionHistory` hook from Story 1.1
- Uses `TransactionFilters` component
- Combines with address and transaction type filters (AND logic)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

_To be populated when story is implemented_

## QA Results

_To be populated by QA agent_


