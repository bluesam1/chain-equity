# Story 6.2: Create Block Lookup React Hook

## Status
Ready for Review

## Story

**As a** developer,  
**I want** a React hook `useBlockLookup` that manages block lookup state and operations,  
**so that** the UI can easily integrate block lookup functionality.

## Acceptance Criteria

1. Create `useBlockLookup` hook in `frontend/src/hooks/useBlockLookup.ts`
2. Hook must manage state: loading, error, result (block number, timestamp), progress indicator
3. Hook must expose `lookupBlock` function that accepts date/time string and performs lookup
4. Hook must detect browser timezone using `Intl.DateTimeFormat().resolvedOptions().timeZone`
5. Hook must convert user's date/time (local timezone) to Unix timestamp (UTC) for blockchain queries
6. Hook must convert found block's timestamp back to user's timezone for display
7. Hook must show progress during binary search (e.g., current search range)
8. Hook must handle errors gracefully and provide user-friendly error messages
9. Hook must use existing `ethers.BrowserProvider` pattern for blockchain queries
10. Hook must follow existing hook patterns (similar to `useCapTable`, `useExecuteSplit`)

## Tasks / Subtasks

- [x] Create `frontend/src/hooks/useBlockLookup.ts` file (AC: 1)
  - [x] Set up file structure with imports
  - [x] Define TypeScript interfaces for state
- [x] Implement state management (AC: 2)
  - [x] Create state for loading, error, result (block number, timestamp)
  - [x] Create state for progress indicator (current search range)
  - [x] Use React `useState` hook
- [x] Implement timezone detection (AC: 4)
  - [x] Use `Intl.DateTimeFormat().resolvedOptions().timeZone`
  - [x] Store timezone in hook state
  - [x] Expose timezone for UI display
- [x] Implement timezone conversion functions (AC: 5, 6)
  - [x] Create function to convert local date/time to Unix timestamp (UTC)
  - [x] Create function to convert Unix timestamp to local date/time string
  - [x] Handle timezone conversions correctly
- [x] Implement `lookupBlock` function (AC: 3, 7, 8, 9)
  - [x] Accept date/time string parameter
  - [x] Convert to Unix timestamp
  - [x] Call `findBlockByTimestamp` from blockLookup utilities
  - [x] Update progress indicator during binary search
  - [x] Handle errors and convert to user-friendly messages
  - [x] Update state with results
- [x] Follow existing hook patterns (AC: 10)
  - [x] Review `useCapTable` and `useExecuteSplit` patterns
  - [x] Match state management approach
  - [x] Match error handling approach
  - [x] Match return value structure
- [x] Add TypeScript types and JSDoc comments
  - [x] Define interfaces for hook state
  - [x] Add JSDoc comments for all functions
  - [x] Export types for use in components

## Dev Notes

### Relevant Source Tree Info
- Hook file location: `frontend/src/hooks/useBlockLookup.ts`
- Uses utilities from: `frontend/src/lib/blockLookup.ts`
- Follows patterns from: `frontend/src/hooks/useCapTable.ts`, `frontend/src/hooks/useExecuteSplit.ts`
- Uses `ethers.BrowserProvider` from `window.ethereum`

### Architecture Decisions
- React hooks pattern for state management
- Browser timezone detection (no timezone selection)
- Progress indicator for long-running operations
- User-friendly error messages

### Key Constraints
- Must use ethers.js v6 API
- Must handle wallet connection state
- Must provide progress feedback during binary search
- Must convert errors to user-friendly messages

### Testing
- **Test File Location**: `frontend/src/hooks/__tests__/useBlockLookup.test.ts` (to be created)
- **Test Standards**: Unit tests for hook logic, mock RPC calls
- **Testing Frameworks**: React Testing Library, Jest or Vitest
- **Specific Requirements**: 
  - Test timezone detection and conversion
  - Test state management
  - Test error handling
  - Test progress indicator updates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Product Owner |
| 2024-12-XX | 1.1 | Implementation completed | Developer |

## Dev Agent Record

### Agent Model Used
Auto (Agent Router)

### Debug Log References
None - implementation completed without issues

### Completion Notes List
- Created `frontend/src/hooks/useBlockLookup.ts` with complete implementation
- Implemented state management using React `useState` hook
- State includes: status, error, result (block number, timestamp), progress (current search range), timezone
- Implemented timezone detection using `Intl.DateTimeFormat().resolvedOptions().timeZone`
- Created `convertLocalDateTimeToUnixTimestamp` function to convert local date/time to Unix timestamp (UTC)
- Created `convertUnixTimestampToLocalDateTime` function to convert Unix timestamp to local date/time string
- Implemented `lookupBlock` function that accepts date/time string and performs lookup
- Progress callback updates state during binary search with current search range
- Error handling converts errors to user-friendly messages (FutureDateError, BeforeDeploymentError, network errors, etc.)
- Uses `ethers.BrowserProvider` pattern for blockchain queries
- Follows existing hook patterns from `useCapTable` and `useExecuteSplit`
- Added TypeScript interfaces: `BlockLookupStatus`, `BlockLookupProgress`, `BlockLookupState`
- Added comprehensive JSDoc comments to all functions
- Exported types for use in components

### File List
- `frontend/src/hooks/useBlockLookup.ts` (created)

## QA Results
_To be populated by QA agent_

