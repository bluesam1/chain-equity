# Story 6.1: Implement Block Lookup Algorithm and Utilities

## Status
Ready for Review

## Story

**As a** developer,  
**I want** block lookup utility functions that can find a block number by timestamp,  
**so that** the application can convert user-provided date/time to block numbers.

## Acceptance Criteria

1. Create utility function `findBlockByTimestamp` that implements binary search algorithm to find the latest block with timestamp ≤ target timestamp
2. Create utility function `getContractDeploymentBlock` that finds the contract deployment block number by querying the contract's creation transaction
3. Binary search algorithm must efficiently search between contract deployment block and current block
4. Algorithm must handle edge cases: future dates (return error), dates before contract deployment (return error)
5. Algorithm must return the exact block number (latest block with timestamp ≤ target)
6. Utility functions must use ethers.js v6 API consistently
7. Functions must be placed in `frontend/src/lib/blockLookup.ts`
8. Functions must include TypeScript types and JSDoc comments

## Tasks / Subtasks

- [x] Create `frontend/src/lib/blockLookup.ts` file (AC: 7)
  - [x] Set up file structure with imports
  - [x] Add TypeScript types and interfaces
- [x] Implement `getContractDeploymentBlock` function (AC: 2)
  - [x] Get contract address from environment variable
  - [x] Query contract's creation transaction
  - [x] Extract block number from deployment transaction
  - [x] Add error handling for contract not found
  - [x] Add JSDoc comments
- [x] Implement `findBlockByTimestamp` function (AC: 1, 3, 4, 5)
  - [x] Get current block number
  - [x] Get contract deployment block number
  - [x] Validate target timestamp (check future date, before deployment)
  - [x] Implement binary search algorithm
  - [x] Return latest block with timestamp ≤ target
  - [x] Add error handling for edge cases
  - [x] Add JSDoc comments
- [x] Ensure ethers.js v6 API usage (AC: 6)
  - [x] Use `ethers.BrowserProvider` pattern
  - [x] Use `provider.getBlockNumber()` for current block
  - [x] Use `provider.getBlock(blockNumber)` for block info
  - [x] Verify all API calls use v6 syntax
- [x] Add TypeScript types and documentation (AC: 8)
  - [x] Define interfaces for function parameters and return types
  - [x] Add comprehensive JSDoc comments
  - [x] Document algorithm complexity and performance considerations

## Dev Notes

### Relevant Source Tree Info
- Utility file location: `frontend/src/lib/blockLookup.ts`
- Contract address: Retrieved from `VITE_CONTRACT_ADDRESS` environment variable
- Uses existing `getContractAddress()` from `frontend/src/lib/contract.ts`
- Follows existing lib file patterns (similar to `contract.ts`)

### Architecture Decisions
- Binary search algorithm for O(log n) efficiency
- Contract deployment block as minimum search range (not genesis block 0)
- Frontend-only implementation (no backend service needed)
- Uses ethers.js v6 API consistently with existing codebase

### Key Constraints
- Must use ethers.js v6 API (not v5)
- Must handle network errors gracefully
- Must minimize RPC calls to avoid rate limiting
- Must work with both Hardhat local network and Sepolia testnet

### Testing
- **Test File Location**: `frontend/src/lib/__tests__/blockLookup.test.ts` (to be created)
- **Test Standards**: Unit tests for algorithm logic, integration tests for RPC calls
- **Testing Frameworks**: Jest or Vitest (match existing frontend test setup)
- **Specific Requirements**: 
  - Test binary search algorithm with mock block data
  - Test contract deployment block detection
  - Test edge cases: future dates, before deployment
  - Test error handling for network failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-XX | 1.0 | Initial story creation | Product Owner |
| 2024-12-XX | 1.1 | Implementation completed | Developer |

## Dev Agent Record

### Agent Model Used
Auto (Agent Router)

### Debug Log References
None - implementation completed without issues

### Completion Notes List
- Created `frontend/src/lib/blockLookup.ts` with complete implementation
- Implemented `getContractDeploymentBlock` function using binary search on contract code existence
- Implemented `findBlockByTimestamp` function using binary search algorithm
- Added custom error classes: `FutureDateError`, `BeforeDeploymentError`, `ContractNotFoundError`
- Added TypeScript interfaces: `BlockLookupResult`, `ProgressCallback`
- All functions use ethers.js v6 API (`Provider` type, `getBlockNumber()`, `getBlock()`, `getCode()`)
- Binary search algorithm efficiently finds blocks with O(log n) complexity
- Contract deployment block detection uses `provider.getCode()` to find first block where contract exists
- All edge cases handled: future dates, before deployment, contract not found
- Comprehensive JSDoc comments added to all functions
- Created test file `frontend/src/lib/__tests__/blockLookup.test.ts` with Vitest structure
- NOTE: Tests require Vitest to be installed and configured (not yet set up in project)

### File List
- `frontend/src/lib/blockLookup.ts` (created)
- `frontend/src/lib/__tests__/blockLookup.test.ts` (created)

## QA Results
_To be populated by QA agent_

