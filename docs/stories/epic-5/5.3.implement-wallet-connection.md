# Story 5.3: Implement Wallet Connection and MetaMask Integration

## Status
Draft

## Story

**As a** user,
**I want** to connect my MetaMask wallet to the application,
**so that** I can interact with the tokenized equity platform.

## Acceptance Criteria

1. Wallet connection flow implemented per Front-End Specification (`docs/front-end-spec.md`)
2. MetaMask wallet detection and connection
3. Network validation (Hardhat local - Chain ID 31337)
4. Network indicator displayed in navigation (green for correct, red for wrong)
5. Error handling for all edge cases:
   - MetaMask not installed
   - User rejects connection
   - Wrong network detected
   - Wallet locked
6. Wallet address displayed in navigation (truncated: first 4 + last 4 characters)
7. Copy wallet address functionality
8. Disconnect wallet functionality
9. Wallet connection state persisted across page reloads
10. UI follows Landing/Wallet Connection wireframe from specification

## Tasks / Subtasks

- [ ] Implement wallet connection hook (AC: 1, 2)
  - [ ] Create `frontend/src/hooks/useWallet.ts`
  - [ ] Implement MetaMask detection
  - [ ] Implement wallet connection request
  - [ ] Implement wallet state management
  - [ ] Add TypeScript types
- [ ] Implement network validation (AC: 3)
  - [ ] Check network on connection (Chain ID 31337)
  - [ ] Validate network before transactions
  - [ ] Implement network switch request
  - [ ] Add network validation error handling
- [ ] Implement network indicator component (AC: 4)
  - [ ] Create network indicator in navigation
  - [ ] Show "Local Dev Network" when connected (green)
  - [ ] Show warning (red) if wrong network
  - [ ] Add tooltip with Chain ID and RPC URL
  - [ ] Follow Wallet Connection Badge specification
- [ ] Implement error handling (AC: 5)
  - [ ] Handle MetaMask not installed (show install instructions)
  - [ ] Handle user rejection (return to landing, no error)
  - [ ] Handle wrong network (show error + switch button)
  - [ ] Handle wallet locked (show unlock message)
  - [ ] Follow error handling from specification
- [ ] Implement wallet address display (AC: 6)
  - [ ] Display truncated address (first 4 + last 4)
  - [ ] Show full address on hover/click
  - [ ] Follow Wallet Connection Badge specification
- [ ] Implement copy address functionality (AC: 7)
  - [ ] Add copy button to wallet address
  - [ ] Implement clipboard copy
  - [ ] Show success feedback on copy
- [ ] Implement disconnect functionality (AC: 8)
  - [ ] Add disconnect button
  - [ ] Clear wallet state on disconnect
  - [ ] Return to landing page
- [ ] Implement state persistence (AC: 9)
  - [ ] Store wallet connection state in localStorage
  - [ ] Restore wallet connection on page reload
  - [ ] Re-validate network on restore
- [ ] Implement Landing/Wallet Connection UI (AC: 10)
  - [ ] Create `frontend/src/pages/Landing.tsx`
  - [ ] Implement centered connection card
  - [ ] Add "Connect Wallet" primary button
  - [ ] Add MetaMask icon/instructions if wallet not detected
  - [ ] Follow wireframe from specification
  - [ ] Use dark theme colors
  - [ ] Implement smooth transition to dashboard after connection

## Dev Notes

### Relevant Source Tree Info
- Wallet hook: `frontend/src/hooks/useWallet.ts`
- Landing page: `frontend/src/pages/Landing.tsx`
- Wallet badge component: `frontend/src/components/WalletBadge.tsx` (from Story 5.2)
- Network configuration: See `docs/front-end-spec.md` - Network Configuration section

### Front-End Specification References
- **User Flow:** See `docs/front-end-spec.md` - User Flows > Wallet Connection & Authentication section
- **Wireframe:** See `docs/front-end-spec.md` - Wireframes & Mockups > Landing / Wallet Connection section
- **Component:** See `docs/front-end-spec.md` - Component Library > Wallet Connection Badge section
- **Network Config:** See `docs/front-end-spec.md` - Network Configuration section
- **Edge Cases:** See `docs/front-end-spec.md` - User Flows > Wallet Connection > Edge Cases & Error Handling

### Architecture Decisions
- Use wagmi v2 for wallet connection (already installed)
- Use ethers.js v6 for blockchain interactions
- Network validation required before all transactions
- State persistence via localStorage
- Network indicator always visible when connected

### Key Constraints
- Only dev-net (Hardhat local) supported (Chain ID 31337)
- Must follow wallet connection flow from specification exactly
- Must handle all edge cases from specification
- Must use dark theme colors
- Must be accessible (keyboard navigation, screen reader)

### Testing
- **Test File Location**: `frontend/src/hooks/__tests__/useWallet.test.ts`
- **Test Standards**: React Testing Library, Vitest
- **Testing Frameworks**: Vitest with React Testing Library
- **Specific Requirements**: 
  - Test wallet connection flow
  - Test network validation
  - Test error handling (all edge cases)
  - Test state persistence
  - Test wallet address display and copy
  - Test disconnect functionality
  - Manual testing with MetaMask

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Product Owner |

## Dev Agent Record

_To be populated by development agent during implementation_

## QA Results

_To be populated by QA agent_

