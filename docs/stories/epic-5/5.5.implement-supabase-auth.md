# Story 5.5: Implement Supabase Web3 Authentication

## Status
Draft

## Story

**As a** user,
**I want** to authenticate with Supabase using my Web3 wallet,
**so that** I can access the application with secure session management.

## Acceptance Criteria

1. Supabase Web3 authentication implemented per Front-End Specification (`docs/front-end-spec.md`)
2. Supabase client configured and initialized
3. Web3 authentication flow (wallet signature for authentication)
4. Session management (create, restore, destroy)
5. Admin role detection (check on-chain RBAC)
6. User profile stored in Supabase
7. Session persistence across page reloads
8. Logout/disconnect functionality
9. Error handling for authentication failures
10. Integration with wallet connection flow

## Tasks / Subtasks

- [ ] Configure Supabase client (AC: 1, 2)
  - [ ] Create `frontend/src/lib/supabase.ts`
  - [ ] Initialize Supabase client with environment variables
  - [ ] Configure Web3 authentication
  - [ ] Add TypeScript types
- [ ] Implement Web3 authentication flow (AC: 3)
  - [ ] Create `frontend/src/hooks/useAuth.ts`
  - [ ] Implement wallet signature request
  - [ ] Implement Supabase Web3 auth sign-in
  - [ ] Handle authentication response
  - [ ] Add TypeScript types
- [ ] Implement session management (AC: 4)
  - [ ] Create session on successful authentication
  - [ ] Restore session on page reload
  - [ ] Destroy session on logout
  - [ ] Store session in localStorage
  - [ ] Handle session expiration
- [ ] Implement admin role detection (AC: 5)
  - [ ] Check on-chain RBAC for admin role
  - [ ] Query contract for user role
  - [ ] Store admin status in session
  - [ ] Update UI based on admin status
- [ ] Implement user profile storage (AC: 6)
  - [ ] Store wallet address in Supabase profile
  - [ ] Store session data in Supabase
  - [ ] Update profile on authentication
- [ ] Implement session persistence (AC: 7)
  - [ ] Restore session from localStorage on page load
  - [ ] Re-validate session with Supabase
  - [ ] Re-check admin role on restore
- [ ] Implement logout functionality (AC: 8)
  - [ ] Add logout function
  - [ ] Clear Supabase session
  - [ ] Clear localStorage
  - [ ] Clear wallet connection
  - [ ] Return to landing page
- [ ] Implement error handling (AC: 9)
  - [ ] Handle authentication failures
  - [ ] Handle session errors
  - [ ] Show error messages to user
  - [ ] Provide retry option
- [ ] Integrate with wallet connection (AC: 10)
  - [ ] Trigger Supabase auth after wallet connection
  - [ ] Follow wallet connection flow from specification
  - [ ] Update wallet connection flow to include Supabase auth

## Dev Notes

### Relevant Source Tree Info
- Supabase client: `frontend/src/lib/supabase.ts`
- Auth hook: `frontend/src/hooks/useAuth.ts`
- Environment variables: `frontend/.env` (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
- Session storage: localStorage

### Front-End Specification References
- **User Flow:** See `docs/front-end-spec.md` - User Flows > Wallet Connection & Authentication section
- **Integration:** Supabase auth integrated into wallet connection flow
- **Admin Role:** Admin role detection for showing/hiding Admin tab

### Architecture Decisions
- Supabase Web3 Auth for authentication
- Session stored in localStorage
- Admin role checked on-chain (contract RBAC)
- Session persistence across page reloads

### Key Constraints
- Must use Supabase Web3 Auth
- Must integrate with wallet connection flow
- Must check admin role on-chain
- Must handle authentication errors gracefully
- Must follow wallet connection flow from specification

### Testing
- **Test File Location**: `frontend/src/hooks/__tests__/useAuth.test.ts`
- **Test Standards**: React Testing Library, Vitest
- **Testing Frameworks**: Vitest with React Testing Library
- **Specific Requirements**: 
  - Test authentication flow
  - Test session management
  - Test admin role detection
  - Test session persistence
  - Test logout functionality
  - Test error handling
  - Manual testing with Supabase

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Product Owner |

## Dev Agent Record

_To be populated by development agent during implementation_

## QA Results

_To be populated by QA agent_

