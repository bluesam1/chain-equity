# Story 5.13: Implement Cap Table Export

## Status
Draft

## Story

**As a** user,
**I want** to export the cap table data in CSV or JSON format,
**so that** I can analyze the ownership data offline.

## Acceptance Criteria

1. Cap Table export implemented per Front-End Specification (`docs/front-end-spec.md`)
2. Export Cap Table flow implemented per specification (Export Cap Table user flow)
3. Export button with format selector (CSV/JSON)
4. Block height input (optional, for historical queries)
5. Export functionality:
   - Generate cap table data
   - Format data as CSV or JSON
   - Trigger file download
6. Loading state during export generation
7. Success message after export
8. Error handling for all edge cases:
   - Invalid block height
   - Block not found
   - Large dataset
   - Export failure
9. UI follows Dashboard - Cap Table Tab wireframe from specification
10. Accessible (keyboard navigation, screen reader)

## Tasks / Subtasks

- [ ] Add export button to Cap Table tab (AC: 1, 3, 9)
  - [ ] Add export button to `frontend/src/pages/CapTable.tsx`
  - [ ] Add format selector (CSV/JSON)
  - [ ] Use Button component from Story 5.2
  - [ ] Follow wireframe from specification
- [ ] Implement block height input (AC: 4)
  - [ ] Add block height input (optional)
  - [ ] Default to latest block
  - [ ] Allow historical queries
  - [ ] Use Input component from Story 5.2
- [ ] Implement export functionality (AC: 5)
  - [ ] Create `frontend/src/lib/capTableExport.ts`
  - [ ] Generate cap table data (use useCapTable hook)
  - [ ] Format data as CSV
  - [ ] Format data as JSON
  - [ ] Trigger file download
  - [ ] Add TypeScript types
- [ ] Implement loading state (AC: 6)
  - [ ] Show loading spinner during export generation
  - [ ] Use StatusIndicator component (Pending variant) from Story 5.2
  - [ ] Show loading message
  - [ ] Disable export button during generation
- [ ] Implement success message (AC: 7)
  - [ ] Show success message after export
  - [ ] Use StatusIndicator component (Success variant) from Story 5.2
  - [ ] Auto-dismiss after 5 seconds
- [ ] Implement error handling (AC: 8)
  - [ ] Handle invalid block height (validate format and range)
  - [ ] Handle block not found (show error if block doesn't exist)
  - [ ] Handle large dataset (show loading state, consider pagination)
  - [ ] Handle export failure (show error with retry option)
  - [ ] Follow error handling from specification
- [ ] Verify accessibility (AC: 10)
  - [ ] Test keyboard navigation
  - [ ] Test screen reader compatibility
  - [ ] Verify focus indicators
  - [ ] Verify button labels

## Dev Notes

### Relevant Source Tree Info
- Cap Table page: `frontend/src/pages/CapTable.tsx`
- Cap Table export: `frontend/src/lib/capTableExport.ts`
- Cap Table hook: `frontend/src/hooks/useCapTable.ts` (from Story 5.12)
- Components: Use components from Story 5.2

### Front-End Specification References
- **User Flow:** See `docs/front-end-spec.md` - User Flows > Export Cap Table section
- **Wireframe:** See `docs/front-end-spec.md` - Wireframes & Mockups > Dashboard - Cap Table Tab section
- **Edge Cases:** See `docs/front-end-spec.md` - User Flows > Export Cap Table > Edge Cases & Error Handling
- **Components:** Use components from Story 5.2

### Architecture Decisions
- Export generated from cap table data
- CSV and JSON formats supported
- Historical queries supported via block height
- File download triggered client-side

### Key Constraints
- Must follow export cap table flow from specification exactly
- Must handle all edge cases from specification
- Must use dark theme colors
- Must be accessible

### Testing
- **Test File Location**: `frontend/src/lib/__tests__/capTableExport.test.ts`
- **Test Standards**: Vitest
- **Testing Frameworks**: Vitest
- **Specific Requirements**: 
  - Test export functionality (CSV)
  - Test export functionality (JSON)
  - Test block height input
  - Test loading state
  - Test success message
  - Test error handling (all edge cases)
  - Test file download
  - Manual testing with contract

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Product Owner |

## Dev Agent Record

_To be populated by development agent during implementation_

## QA Results

_To be populated by QA agent_

